-- Setup table partitioning for improved performance and maintenance

-- Note: PostgreSQL 10+ supports native partitioning
-- We'll use RANGE partitioning on timestamp columns

-- Partitioning ROUTES by saved_at (monthly)
ALTER TABLE routes
    ENABLE ROW LEVEL SECURITY;

-- Partitioning BOOKINGS by created_at (quarterly)
ALTER TABLE bookings
    ENABLE ROW LEVEL SECURITY;

-- Create partitions for ROUTES (save_at monthly)
-- Current year and next year partitions
CREATE TABLE IF NOT EXISTS routes_2024_q1 PARTITION OF routes
    FOR VALUES FROM ('2024-01-01') TO ('2024-04-01');

CREATE TABLE IF NOT EXISTS routes_2024_q2 PARTITION OF routes
    FOR VALUES FROM ('2024-04-01') TO ('2024-07-01');

CREATE TABLE IF NOT EXISTS routes_2024_q3 PARTITION OF routes
    FOR VALUES FROM ('2024-07-01') TO ('2024-10-01');

CREATE TABLE IF NOT EXISTS routes_2024_q4 PARTITION OF routes
    FOR VALUES FROM ('2024-10-01') TO ('2025-01-01');

CREATE TABLE IF NOT EXISTS routes_2025_q1 PARTITION OF routes
    FOR VALUES FROM ('2025-01-01') TO ('2025-04-01');

CREATE TABLE IF NOT EXISTS routes_2025_q2 PARTITION OF routes
    FOR VALUES FROM ('2025-04-01') TO ('2025-07-01');

CREATE TABLE IF NOT EXISTS routes_2025_q3 PARTITION OF routes
    FOR VALUES FROM ('2025-07-01') TO ('2025-10-01');

CREATE TABLE IF NOT EXISTS routes_2025_q4 PARTITION OF routes
    FOR VALUES FROM ('2025-10-01') TO ('2026-01-01');

-- Create partitions for BOOKINGS (created_at quarterly)
CREATE TABLE IF NOT EXISTS bookings_2024_q1 PARTITION OF bookings
    FOR VALUES FROM ('2024-01-01') TO ('2024-04-01');

CREATE TABLE IF NOT EXISTS bookings_2024_q2 PARTITION OF bookings
    FOR VALUES FROM ('2024-04-01') TO ('2024-07-01');

CREATE TABLE IF NOT EXISTS bookings_2024_q3 PARTITION OF bookings
    FOR VALUES FROM ('2024-07-01') TO ('2024-10-01');

CREATE TABLE IF NOT EXISTS bookings_2024_q4 PARTITION OF bookings
    FOR VALUES FROM ('2024-10-01') TO ('2025-01-01');

CREATE TABLE IF NOT EXISTS bookings_2025_q1 PARTITION OF bookings
    FOR VALUES FROM ('2025-01-01') TO ('2025-04-01');

CREATE TABLE IF NOT EXISTS bookings_2025_q2 PARTITION OF bookings
    FOR VALUES FROM ('2025-04-01') TO ('2025-07-01');

CREATE TABLE IF NOT EXISTS bookings_2025_q3 PARTITION OF bookings
    FOR VALUES FROM ('2025-07-01') TO ('2025-10-01');

CREATE TABLE IF NOT EXISTS bookings_2025_q4 PARTITION OF bookings
    FOR VALUES FROM ('2025-10-01') TO ('2026-01-01');

-- Create partitions for PAYMENTS (created_at quarterly)
CREATE TABLE IF NOT EXISTS payments_2024_q1 PARTITION OF payments
    FOR VALUES FROM ('2024-01-01') TO ('2024-04-01');

CREATE TABLE IF NOT EXISTS payments_2024_q2 PARTITION OF payments
    FOR VALUES FROM ('2024-04-01') TO ('2024-07-01');

CREATE TABLE IF NOT EXISTS payments_2024_q3 PARTITION OF payments
    FOR VALUES FROM ('2024-07-01') TO ('2024-10-01');

CREATE TABLE IF NOT EXISTS payments_2024_q4 PARTITION OF payments
    FOR VALUES FROM ('2024-10-01') TO ('2025-01-01');

CREATE TABLE IF NOT EXISTS payments_2025_q1 PARTITION OF payments
    FOR VALUES FROM ('2025-01-01') TO ('2025-04-01');

CREATE TABLE IF NOT EXISTS payments_2025_q2 PARTITION OF payments
    FOR VALUES FROM ('2025-04-01') TO ('2025-07-01');

CREATE TABLE IF NOT EXISTS payments_2025_q3 PARTITION OF payments
    FOR VALUES FROM ('2025-07-01') TO ('2025-10-01');

CREATE TABLE IF NOT EXISTS payments_2025_q4 PARTITION OF payments
    FOR VALUES FROM ('2025-10-01') TO ('2026-01-01');

-- Add comments
COMMENT ON TABLE routes_2024_q1 IS 'Partition of routes table for Q1 2024';
COMMENT ON TABLE bookings_2024_q1 IS 'Partition of bookings table for Q1 2024';
COMMENT ON TABLE payments_2024_q1 IS 'Partition of payments table for Q1 2024';
